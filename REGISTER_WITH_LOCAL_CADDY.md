# Registering Vibe-OS with Local Caddy Reverse Proxy

Vibe-OS integrates with the shared `~/Caddy` reverse proxy infrastructure used by all `*.localhost` projects on this machine.

## How It Works

The `./install-service` script:

1. **Validates** that `~/Caddy` exists and is properly configured
2. **Generates** a site config at `~/Caddy/sites/vibeos.Caddyfile`
3. **Reloads** Caddy to pick up the new config
4. **On uninstall**, removes the site config and reloads Caddy

This follows the same pattern as:
- `~/whisper-mlx/install-service` → `http://qwen.localhost`
- `~/Github/openchessvision/install-service` → `http://books.chess.localhost`

## How *.localhost DNS Resolution Works

**No `/etc/hosts` entries are needed!**

The `.localhost` TLD is reserved by [RFC 6761](https://datatracker.ietf.org/doc/html/rfc6761) and is automatically resolved to `127.0.0.1` by:

- macOS (since 10.15+)
- Modern browsers (Chrome, Firefox, Safari)
- curl and other HTTP clients

## The Shared Caddy Setup

A single Caddy instance at `~/Caddy/` serves all `*.localhost` domains:

```
~/Caddy/
├── Caddyfile              # Main config: `import sites/*.Caddyfile`
├── sites/
│   ├── cigna.Caddyfile    → http://cigna.localhost
│   ├── qwen.Caddyfile     → http://qwen.localhost
│   ├── vibeos.Caddyfile   → http://vibeos.localhost  ← Generated by install-service
│   └── ...
├── bin/
│   └── caddy-wrapper      # Used by launchd
└── com.localhost.caddy.plist
```

Caddy runs as a shared macOS LaunchAgent (`com.localhost.caddy`) and listens on port 80.

## Vibe-OS Site Configuration

The generated `~/Caddy/sites/vibeos.Caddyfile`:

```caddyfile
# Vibe-OS Dashboard - http://vibeos.localhost
http://vibeos.localhost {
    handle /api/* {
        reverse_proxy 127.0.0.1:8485
    }
    handle {
        reverse_proxy 127.0.0.1:34853
    }
}
```

| URL Pattern                      | Proxied To           | Service        |
|----------------------------------|----------------------|----------------|
| `http://vibeos.localhost/api/*`  | `127.0.0.1:8485`     | Rust API       |
| `http://vibeos.localhost/*`      | `127.0.0.1:34853`    | Vite Dashboard |

### Why 127.0.0.1 Instead of localhost?

Caddy's `reverse_proxy` directive can resolve `localhost` to IPv6 (`::1`) on macOS, but our services bind to IPv4 only. Using `127.0.0.1` explicitly avoids this mismatch.

### Why These Ports?

We use "rare" ports (8485, 34853) to avoid conflicts with common development ports like 3000, 5173, 8080, etc.

## Commands

```bash
# Install services + register with Caddy
./install-service install

# Check status (shows all *.localhost sites)
./install-service status

# Uninstall (removes Caddy site config)
./install-service uninstall
```

## Troubleshooting

### Caddy not running?

```bash
cd ~/Caddy && nix develop --command caddy-status
# If not running:
cd ~/Caddy && nix develop --command caddy-restart
```

### Config syntax error?

```bash
cd ~/Caddy && nix develop --command caddy-validate
```

### Services not responding through Caddy?

Check direct access first:

```bash
curl -s http://127.0.0.1:8485/api/meta   # API
curl -s http://127.0.0.1:34853/          # Dashboard
```

If direct works but Caddy doesn't, check:

```bash
cat ~/Caddy/sites/vibeos.Caddyfile  # Is the config correct?
cd ~/Caddy && nix develop --command caddy-reload
```

## See Also

- `~/Caddy/README.md` - Full documentation for the shared Caddy setup
- `~/whisper-mlx/install-service` - Example of another project using this pattern
